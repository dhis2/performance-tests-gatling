name: Tracker Performance Tests Template

on:
  workflow_call:
    inputs:
      runner-type:
        required: true
        type: string
        description: 'Runner type to use (e.g., ubuntu-24.04, buildjet-2vcpu-ubuntu-2204)'
      share-connections:
        required: false
        type: boolean
        default: false
        description: 'Whether to use shared HTTP connections in Gatling tests'
      test-target:
        required: false
        type: string
        default: 'local'
        description: 'Test target: local (Docker) or play (play.im.dhis2.org)'
  workflow_dispatch:
    inputs:
      runner-type:
        required: true
        type: choice
        description: 'Runner type to use'
        # https://docs.github.com/en/actions/how-tos/using-github-hosted-runners/using-github-hosted-runners/about-github-hosted-runners#standard-github-hosted-runners-for--private-repositories
        # https://buildjet.com/for-github-actions/docs/about/pricing#amd
        options:
          - ubuntu-24.04
          - buildjet-2vcpu-ubuntu-2204
        default: ubuntu-24.04
      share-connections:
        required: false
        type: boolean
        default: false
        description: 'Whether to use shared HTTP connections in Gatling tests'
      test-target:
        required: false
        type: choice
        description: 'Test target'
        options:
          - local
          - play
        default: local

jobs:
  performance-tests:
    if: github.actor == github.repository_owner
    runs-on: ${{ inputs.runner-type }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Start DHIS2
      if: inputs.test-target == 'local'
      run: |
        DHIS2_IMAGE=dhis2/core:42.0 \
        DHIS2_DB_DUMP_URL=https://databases.dhis2.org/sierra-leone/2.42.0/dhis2-db-sierra-leone.sql.gz \
        docker compose up --detach

    - name: Wait for DHIS2 to be ready
      if: inputs.test-target == 'local'
      run: |
        echo "Waiting for DHIS2 to start..."
        timeout 300 bash -c 'until docker compose ps | grep -q "healthy"; do sleep 10; echo "Still waiting..."; done'
        echo "DHIS2 is ready!"

    - name: Run tracker performance tests
      run: |
        mvn clean gatling:test -Dgatling.simulationClass=org.hisp.dhis.test.TrackerExporterTests ${{ inputs.share-connections && '-DshareConnections' || '' }} ${{ inputs.test-target == 'play' && '-Dinstance=https://play.im.dhis2.org/stable-2-42-0' || '' }}

    - name: Upload Gatling report
      if: always() # reports should always be uploaded as tests can fail due to our performance assertions
      uses: actions/upload-artifact@v4
      with:
        name: gatling-report-${{ inputs.runner-type }}${{ inputs.test-target == 'play' && '-play' || '' }}${{ inputs.share-connections && '-shared' || '' }}-${{ github.run_id }}-${{ github.sha }}
        path: |
          target/gatling/
          !target/gatling/lastRun.txt

    - name: Cleanup
      if: inputs.test-target == 'local' && always()
      run: docker compose down --volumes
